name: Deploy to AWS

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:  # Allows manual trigger from GitHub UI
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  AWS_REGION: us-east-1
  STACK_NAME: questrade-lunchmoney-sync

permissions:
  contents: read
  id-token: write  # Required for AWS OIDC

jobs:
  deploy:
    name: Deploy SAM Application
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pip install pytest pytest-cov
          python -m pytest tests/ -v --cov=src --cov-report=term-missing

      - name: Set up AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          use-installer: true

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # Option 1: Use OIDC (recommended for security - no long-lived credentials)
          # Requires setting up OIDC provider in AWS
          # role-to-assume: ${{ secrets.AWS_ROLE_ARN }}

          # Option 2: Use IAM access keys (simpler setup)
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Validate SAM template
        run: sam validate --lint

      - name: Build SAM application
        run: sam build --use-container

      - name: Check and create Secrets Manager secret
        id: check-secret
        run: |
          SECRET_NAME="${{ vars.QUESTRADE_SECRET_NAME || 'questrade-lunchmoney/questrade-tokens' }}"
          echo "secret_name=${SECRET_NAME}" >> $GITHUB_OUTPUT

          # Parse QUESTRADE_TOKENS from comma-separated format to JSON
          # Input format: 12345:token1,67890:token2,11111:token3
          # Output format: {"12345":"token1","67890":"token2","11111":"token3"}
          TOKENS_CSV="${{ secrets.QUESTRADE_TOKENS }}"

          if [ -n "$TOKENS_CSV" ]; then
            TOKENS_JSON=$(echo "$TOKENS_CSV" | awk -F',' '
              BEGIN { printf "{" }
              {
                for(i=1; i<=NF; i++) {
                  split($i, parts, ":")
                  printf "\"%s\":\"%s\"", parts[1], parts[2]
                  if(i < NF) printf ","
                }
              }
              END { printf "}" }
            ')
            echo "Parsed tokens for $(echo "$TOKENS_JSON" | jq 'keys | length') account(s)"
          else
            TOKENS_JSON=""
          fi

          # Check if secret exists
          if aws secretsmanager describe-secret --secret-id "${SECRET_NAME}" --region ${{ env.AWS_REGION }} 2>/dev/null; then
            echo "Secret ${SECRET_NAME} already exists"
            echo "secret_exists=true" >> $GITHUB_OUTPUT
            # Don't pass refresh tokens to SAM if secret exists
            echo "pass_tokens=" >> $GITHUB_OUTPUT
          else
            echo "Secret ${SECRET_NAME} does not exist, will be created by CloudFormation"
            echo "secret_exists=false" >> $GITHUB_OUTPUT
            # Pass refresh tokens JSON to SAM to create secret
            echo "pass_tokens=${TOKENS_JSON}" >> $GITHUB_OUTPUT
          fi

      - name: Check and delete stack if in ROLLBACK_COMPLETE state
        continue-on-error: true
        run: |
          STACK_STATUS=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].StackStatus' \
            --output text 2>/dev/null || echo "DOES_NOT_EXIST")

          if [ "$STACK_STATUS" = "ROLLBACK_COMPLETE" ]; then
            echo "Stack is in ROLLBACK_COMPLETE state, deleting..."
            aws cloudformation delete-stack \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }}
            echo "Waiting for stack deletion..."
            aws cloudformation wait stack-delete-complete \
              --stack-name ${{ env.STACK_NAME }} \
              --region ${{ env.AWS_REGION }}
            echo "Stack deleted successfully"
          else
            echo "Stack status: $STACK_STATUS"
          fi

      - name: Deploy SAM application
        run: |
          # Use samconfig.toml approach or individual parameter format
          # Build parameters string carefully to avoid space-related issues

          PARAM_OVERRIDES="QuestradeRefreshTokens=\"${{ steps.check-secret.outputs.pass_tokens }}\" "
          PARAM_OVERRIDES+="LunchMoneyApiToken=\"${{ secrets.LUNCHMONEY_API_TOKEN }}\" "
          PARAM_OVERRIDES+="SyncDaysBack=\"${{ vars.SYNC_DAYS_BACK || '31' }}\" "
          PARAM_OVERRIDES+="SyncSchedule=\"${{ vars.SYNC_SCHEDULE || 'rate(1 day)' }}\" "
          PARAM_OVERRIDES+="LogRetentionDays=\"${{ vars.LOG_RETENTION_DAYS || '30' }}\" "
          PARAM_OVERRIDES+="QuestradeSecretName=\"${{ steps.check-secret.outputs.secret_name }}\" "
          PARAM_OVERRIDES+="UseSecretsManager=\"${{ vars.USE_SECRETS_MANAGER || 'true' }}\" "

          # Only add LunchMoneyAssetId if it has a value
          if [ -n "${{ vars.LUNCHMONEY_ASSET_ID }}" ]; then
            PARAM_OVERRIDES+="LunchMoneyAssetId=\"${{ vars.LUNCHMONEY_ASSET_ID }}\" "
          fi

          sam deploy \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --capabilities CAPABILITY_IAM \
            --resolve-s3 \
            --parameter-overrides $PARAM_OVERRIDES

      - name: Get stack outputs
        id: stack-outputs
        run: |
          FUNCTION_ARN=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`SyncFunction`].OutputValue' \
            --output text)

          SNS_TOPIC=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.STACK_NAME }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ErrorNotificationTopicArn`].OutputValue' \
            --output text)

          echo "function_arn=${FUNCTION_ARN}" >> $GITHUB_OUTPUT
          echo "sns_topic=${SNS_TOPIC}" >> $GITHUB_OUTPUT

      - name: Test Lambda function (optional smoke test)
        if: github.event.inputs.environment == 'staging' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Testing Lambda function..."
          aws lambda invoke \
            --function-name questrade-lunchmoney-sync \
            --region ${{ env.AWS_REGION }} \
            --cli-binary-format raw-in-base64-out \
            --payload '{}' \
            /tmp/response.json

          cat /tmp/response.json

          # Check if invocation was successful
          if grep -q '"statusCode": 200' /tmp/response.json; then
            echo "âœ… Lambda test passed"
          else
            echo "âŒ Lambda test failed"
            exit 1
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Summary ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Stack Name**: ${{ env.STACK_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Region**: ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Function ARN**: ${{ steps.stack-outputs.outputs.function_arn }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SNS Topic**: ${{ steps.stack-outputs.outputs.sns_topic }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Sync Schedule: \`${{ vars.SYNC_SCHEDULE || 'cron(0 8 * * ? *)' }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Sync Days Back: ${{ vars.SYNC_DAYS_BACK || '31' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Log Retention: ${{ vars.LOG_RETENTION_DAYS || '30' }} days" >> $GITHUB_STEP_SUMMARY
          echo "- Using Secrets Manager: ${{ vars.USE_SECRETS_MANAGER || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Secret Name: \`${{ steps.check-secret.outputs.secret_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Token Management" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Questrade refresh token will auto-update in Secrets Manager on each run" >> $GITHUB_STEP_SUMMARY
          echo "âœ… No manual token rotation required" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above for details."
          echo "## Deployment Failed âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment to ${{ env.STACK_NAME }} failed. Please check the workflow logs." >> $GITHUB_STEP_SUMMARY
